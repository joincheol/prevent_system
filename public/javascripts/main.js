const SIDO_SIGUNGU_MAP = {
  "서울특별시": [
    { name: "종로구", lat: 37.5729503, lng: 126.9793579 },
    { name: "중구", lat: 37.5638437, lng: 126.997602 },
    { name: "용산구", lat: 37.5324754, lng: 126.9901583 },
    { name: "성동구", lat: 37.5633415, lng: 127.0368104 },
    { name: "광진구", lat: 37.5384844, lng: 127.0822939 },
    { name: "동대문구", lat: 37.5743683, lng: 127.0395956 },
    { name: "중랑구", lat: 37.6063245, lng: 127.0924034 },
    { name: "성북구", lat: 37.5894009, lng: 127.0166377 },
    { name: "강북구", lat: 37.6396096, lng: 127.0256577 },
    { name: "도봉구", lat: 37.6687687, lng: 127.0471634 },
    { name: "노원구", lat: 37.6541912, lng: 127.0567934 },
    { name: "은평구", lat: 37.6176127, lng: 126.9227004 },
    { name: "서대문구", lat: 37.5791158, lng: 126.9367784 },
    { name: "마포구", lat: 37.5663246, lng: 126.9014014 },
    { name: "양천구", lat: 37.5178297, lng: 126.8663987 },
    { name: "강서구", lat: 37.5509645, lng: 126.8495324 },
    { name: "구로구", lat: 37.4954856, lng: 126.8876391 },
    { name: "금천구", lat: 37.4603732, lng: 126.9001546 },
    { name: "영등포구", lat: 37.5263716, lng: 126.8962295 },
    { name: "동작구", lat: 37.5124092, lng: 126.9392526 },
    { name: "관악구", lat: 37.4784066, lng: 126.9516131 },
    { name: "서초구", lat: 37.4837125, lng: 127.0324115 },
    { name: "강남구", lat: 37.5172363, lng: 127.0473248 },
    { name: "송파구", lat: 37.5145436, lng: 127.1059222 },
    { name: "강동구", lat: 37.5301251, lng: 127.1237629 }
  ],
  "부산광역시": [
    { name: "중구", lat: 35.1064984, lng: 129.0326619 },
    { name: "서구", lat: 35.097944, lng: 129.024147 },
    { name: "동구", lat: 35.129289, lng: 129.045107 },
    { name: "영도구", lat: 35.091288, lng: 129.067036 },
    { name: "부산진구", lat: 35.162934, lng: 129.055917 },
    { name: "동래구", lat: 35.205893, lng: 129.083702 },
    { name: "남구", lat: 35.136577, lng: 129.084383 },
    { name: "북구", lat: 35.197139, lng: 128.990956 },
    { name: "해운대구", lat: 35.163172, lng: 129.163543 },
    { name: "사하구", lat: 35.104049, lng: 128.974670 },
    { name: "금정구", lat: 35.242942, lng: 129.092774 },
    { name: "강서구", lat: 35.212064, lng: 128.980079 },
    { name: "연제구", lat: 35.176619, lng: 129.081346 },
    { name: "수영구", lat: 35.142514, lng: 129.113209 },
    { name: "사상구", lat: 35.154206, lng: 128.990849 },
    { name: "기장군", lat: 35.244399, lng: 129.222119 }
  ],
  "대구광역시": [
    { name: "중구", lat: 35.868595, lng: 128.606499 },
    { name: "동구", lat: 35.886685, lng: 128.628568 },
    { name: "서구", lat: 35.871435, lng: 128.559561 },
    { name: "남구", lat: 35.845993, lng: 128.582744 },
    { name: "북구", lat: 35.885237, lng: 128.582678 },
    { name: "수성구", lat: 35.858052, lng: 128.630865 },
    { name: "달서구", lat: 35.829576, lng: 128.532992 },
    { name: "달성군", lat: 35.774612, lng: 128.431918 },
    { name: "군위군", lat: 36.242077, lng: 128.572449 }
  ],
  "인천광역시": [
    { name: "중구", lat: 37.473294, lng: 126.621955 },
    { name: "동구", lat: 37.484214, lng: 126.643608 },
    { name: "미추홀구", lat: 37.463947, lng: 126.650632 },
    { name: "연수구", lat: 37.410247, lng: 126.678823 },
    { name: "남동구", lat: 37.447340, lng: 126.731667 },
    { name: "부평구", lat: 37.508163, lng: 126.720684 },
    { name: "계양구", lat: 37.538484, lng: 126.736462 },
    { name: "서구", lat: 37.545473, lng: 126.676883 },
    { name: "강화군", lat: 37.746501, lng: 126.487922 },
    { name: "옹진군", lat: 37.441308, lng: 126.099537 }
  ],
  "광주광역시": [
    { name: "동구", lat: 35.146034, lng: 126.923655 },
    { name: "서구", lat: 35.154491, lng: 126.891094 },
    { name: "남구", lat: 35.133264, lng: 126.902201 },
    { name: "북구", lat: 35.174184, lng: 126.911875 },
    { name: "광산구", lat: 35.139984, lng: 126.793032 }
  ],
  "대전광역시": [
    { name: "동구", lat: 36.328690, lng: 127.454666 },
    { name: "중구", lat: 36.325091, lng: 127.421151 },
    { name: "서구", lat: 36.355431, lng: 127.378964 },
    { name: "유성구", lat: 36.362238, lng: 127.356779 },
    { name: "대덕구", lat: 36.373321, lng: 127.434191 }
  ],
  "울산광역시": [
    { name: "중구", lat: 35.569321, lng: 129.332915 },
    { name: "남구", lat: 35.543684, lng: 129.330105 },
    { name: "동구", lat: 35.504755, lng: 129.424062 },
    { name: "북구", lat: 35.582782, lng: 129.360856 },
    { name: "울주군", lat: 35.551997, lng: 129.127202 }
  ],
  "세종특별자치시": [
    { name: "세종시", lat: 36.480132, lng: 127.289016 }
  ],
  "경기도": [
    { name: "수원시", lat: 37.263573, lng: 127.028601 },
    { name: "성남시", lat: 37.420215, lng: 127.126544 },
    { name: "의정부시", lat: 37.738081, lng: 127.033079 },
    { name: "안양시", lat: 37.394265, lng: 126.956767 },
    { name: "부천시", lat: 37.503413, lng: 126.766031 },
    { name: "광명시", lat: 37.478406, lng: 126.864576 },
    { name: "평택시", lat: 36.994520, lng: 127.088339 },
    { name: "동두천시", lat: 37.903411, lng: 127.060894 },
    { name: "안산시", lat: 37.321877, lng: 126.830884 },
    { name: "고양시", lat: 37.658359, lng: 126.832020 },
    { name: "과천시", lat: 37.429289, lng: 126.987020 },
    { name: "구리시", lat: 37.594922, lng: 127.129877 },
    { name: "남양주시", lat: 37.636011, lng: 127.216592 },
    { name: "오산시", lat: 37.149890, lng: 127.077221 },
    { name: "시흥시", lat: 37.380192, lng: 126.805701 },
    { name: "군포시", lat: 37.361623, lng: 126.935019 },
    { name: "의왕시", lat: 37.344081, lng: 126.970817 },
    { name: "하남시", lat: 37.539289, lng: 127.214119 },
    { name: "용인시", lat: 37.241086, lng: 127.177553 },
    { name: "파주시", lat: 37.759859, lng: 126.780224 },
    { name: "이천시", lat: 37.279430, lng: 127.442298 },
    { name: "안성시", lat: 37.008315, lng: 127.271780 },
    { name: "김포시", lat: 37.615317, lng: 126.715877 },
    { name: "화성시", lat: 37.199493, lng: 126.831188 },
    { name: "광주시", lat: 37.429191, lng: 127.255686 },
    { name: "양주시", lat: 37.785448, lng: 127.045252 },
    { name: "포천시", lat: 37.894486, lng: 127.200173 },
    { name: "여주시", lat: 37.298243, lng: 127.636858 },
    { name: "연천군", lat: 38.096614, lng: 127.070012 },
    { name: "가평군", lat: 37.831508, lng: 127.509612 },
    { name: "양평군", lat: 37.491857, lng: 127.487494 }
  ],
  "강원도": [
    { name: "춘천시", lat: 37.881315, lng: 127.729970 },
    { name: "원주시", lat: 37.342218, lng: 127.920162 },
    { name: "강릉시", lat: 37.751853, lng: 128.876057 },
    { name: "동해시", lat: 37.524566, lng: 129.114284 },
    { name: "태백시", lat: 37.164065, lng: 128.985572 },
    { name: "속초시", lat: 38.207014, lng: 128.591848 },
    { name: "삼척시", lat: 37.449888, lng: 129.165911 },
    { name: "홍천군", lat: 37.691933, lng: 127.888786 },
    { name: "횡성군", lat: 37.491506, lng: 127.984237 },
    { name: "영월군", lat: 37.183527, lng: 128.461674 },
    { name: "평창군", lat: 37.370474, lng: 128.390979 },
    { name: "정선군", lat: 37.380149, lng: 128.660479 },
    { name: "철원군", lat: 38.146409, lng: 127.313346 },
    { name: "화천군", lat: 38.105546, lng: 127.706727 },
    { name: "양구군", lat: 38.105217, lng: 127.989105 },
    { name: "인제군", lat: 38.069805, lng: 128.170463 },
    { name: "고성군", lat: 38.380322, lng: 128.467839 },
    { name: "양양군", lat: 38.075454, lng: 128.621675 }
  ],
  "충청북도": [
    { name: "청주시", lat: 36.642434, lng: 127.489032 },
    { name: "충주시", lat: 37.013843, lng: 127.928703 },
    { name: "제천시", lat: 37.132646, lng: 128.190660 },
    { name: "보은군", lat: 36.489397, lng: 127.729122 },
    { name: "옥천군", lat: 36.306438, lng: 127.571691 },
    { name: "영동군", lat: 36.175055, lng: 127.776698 },
    { name: "증평군", lat: 36.785371, lng: 127.582733 },
    { name: "진천군", lat: 36.857708, lng: 127.437208 },
    { name: "괴산군", lat: 36.813455, lng: 127.792722 },
    { name: "음성군", lat: 36.940307, lng: 127.690431 },
    { name: "단양군", lat: 36.984927, lng: 128.365222 }
  ],
  "충청남도": [
    { name: "천안시", lat: 36.815117, lng: 127.113892 },
    { name: "공주시", lat: 36.446553, lng: 127.119488 },
    { name: "보령시", lat: 36.333208, lng: 126.612730 },
    { name: "아산시", lat: 36.792552, lng: 127.001972 },
    { name: "서산시", lat: 36.784499, lng: 126.450316 },
    { name: "논산시", lat: 36.187065, lng: 127.098130 },
    { name: "계룡시", lat: 36.274476, lng: 127.249485 },
    { name: "당진시", lat: 36.893040, lng: 126.629130 },
    { name: "금산군", lat: 36.108219, lng: 127.488591 },
    { name: "부여군", lat: 36.276453, lng: 126.909024 },
    { name: "서천군", lat: 36.080344, lng: 126.691073 },
    { name: "청양군", lat: 36.454913, lng: 126.800244 },
    { name: "홍성군", lat: 36.601515, lng: 126.660776 },
    { name: "예산군", lat: 36.682527, lng: 126.849298 },
    { name: "태안군", lat: 36.745478, lng: 126.297959 }
  ],
  "전라북도": [
    { name: "전주시", lat: 35.824223, lng: 127.148000 },
    { name: "군산시", lat: 35.967677, lng: 126.736629 },
    { name: "익산시", lat: 35.948285, lng: 126.957599 },
    { name: "정읍시", lat: 35.569321, lng: 126.855047 },
    { name: "남원시", lat: 35.416363, lng: 127.390267 },
    { name: "김제시", lat: 35.803220, lng: 126.880954 },
    { name: "완주군", lat: 35.904306, lng: 127.162367 },
    { name: "진안군", lat: 35.791418, lng: 127.424580 },
    { name: "무주군", lat: 36.006930, lng: 127.661553 },
    { name: "장수군", lat: 35.647184, lng: 127.521668 },
    { name: "임실군", lat: 35.613679, lng: 127.289019 },
    { name: "순창군", lat: 35.374215, lng: 127.137163 },
    { name: "고창군", lat: 35.435834, lng: 126.701814 },
    { name: "부안군", lat: 35.731655, lng: 126.733785 }
  ],
  "전라남도": [
    { name: "목포시", lat: 34.811835, lng: 126.392166 },
    { name: "여수시", lat: 34.760373, lng: 127.662222 },
    { name: "순천시", lat: 34.950638, lng: 127.487494 },
    { name: "나주시", lat: 35.015054, lng: 126.710828 },
    { name: "광양시", lat: 34.940695, lng: 127.695885 },
    { name: "담양군", lat: 35.321044, lng: 126.987020 },
    { name: "곡성군", lat: 35.200091, lng: 127.287227 },
    { name: "구례군", lat: 35.203488, lng: 127.462611 },
    { name: "고흥군", lat: 34.607056, lng: 127.284531 },
    { name: "보성군", lat: 34.771900, lng: 127.080744 },
    { name: "화순군", lat: 35.064377, lng: 127.006221 },
    { name: "장흥군", lat: 34.683212, lng: 126.907545 },
    { name: "강진군", lat: 34.642157, lng: 126.765834 },
    { name: "해남군", lat: 34.573179, lng: 126.598247 },
    { name: "영암군", lat: 34.800043, lng: 126.698241 },
    { name: "무안군", lat: 34.990418, lng: 126.476747 },
    { name: "함평군", lat: 35.065285, lng: 126.517011 },
    { name: "영광군", lat: 35.277128, lng: 126.510703 },
    { name: "장성군", lat: 35.303964, lng: 126.784984 },
    { name: "완도군", lat: 34.311246, lng: 126.755885 },
    { name: "진도군", lat: 34.484369, lng: 126.263713 },
    { name: "신안군", lat: 34.829187, lng: 126.108646 }
  ],
  "경상북도": [
    { name: "포항시", lat: 36.019017, lng: 129.343480 },
    { name: "경주시", lat: 35.856171, lng: 129.224747 },
    { name: "김천시", lat: 36.139839, lng: 128.113595 },
    { name: "안동시", lat: 36.568354, lng: 128.729357 },
    { name: "구미시", lat: 36.119485, lng: 128.344573 },
    { name: "영주시", lat: 36.805685, lng: 128.624502 },
    { name: "영천시", lat: 35.973286, lng: 128.940801 },
    { name: "상주시", lat: 36.410946, lng: 128.159132 },
    { name: "문경시", lat: 36.586205, lng: 128.186795 },
    { name: "경산시", lat: 35.825118, lng: 128.741546 },
    { name: "군위군", lat: 36.242077, lng: 128.572449 },
    { name: "의성군", lat: 36.352467, lng: 128.697445 },
    { name: "청송군", lat: 36.435046, lng: 129.057377 },
    { name: "영양군", lat: 36.664929, lng: 129.115507 },
    { name: "영덕군", lat: 36.415333, lng: 129.365634 },
    { name: "청도군", lat: 35.647241, lng: 128.736239 },
    { name: "고령군", lat: 35.727876, lng: 128.273934 },
    { name: "성주군", lat: 35.918278, lng: 128.283391 },
    { name: "칠곡군", lat: 35.995651, lng: 128.401730 },
    { name: "예천군", lat: 36.655248, lng: 128.452253 },
    { name: "봉화군", lat: 36.893018, lng: 128.732839 },
    { name: "울진군", lat: 36.993063, lng: 129.400217 },
    { name: "울릉군", lat: 37.484216, lng: 130.905269 }
  ],
  "경상남도": [
    { name: "창원시", lat: 35.227848, lng: 128.681116 },
    { name: "진주시", lat: 35.180188, lng: 128.107621 },
    { name: "통영시", lat: 34.854865, lng: 128.433610 },
    { name: "사천시", lat: 35.003774, lng: 128.064055 },
    { name: "김해시", lat: 35.228545, lng: 128.889924 },
    { name: "밀양시", lat: 35.503695, lng: 128.747749 },
    { name: "거제시", lat: 34.880444, lng: 128.621552 },
    { name: "양산시", lat: 35.335005, lng: 129.037690 },
    { name: "의령군", lat: 35.319381, lng: 128.261417 },
    { name: "함안군", lat: 35.272642, lng: 128.406215 },
    { name: "창녕군", lat: 35.543759, lng: 128.492136 },
    { name: "고성군", lat: 34.973514, lng: 128.322998 },
    { name: "남해군", lat: 34.837223, lng: 127.892416 },
    { name: "하동군", lat: 35.067231, lng: 127.751341 },
    { name: "산청군", lat: 35.415662, lng: 127.873511 },
    { name: "함양군", lat: 35.520627, lng: 127.725927 },
    { name: "거창군", lat: 35.686324, lng: 127.909302 },
    { name: "합천군", lat: 35.566749, lng: 128.165045 }
  ],
  "제주특별자치도": [
    { name: "제주시", lat: 33.499621, lng: 126.531188 },
    { name: "서귀포시", lat: 33.253021, lng: 126.560092 }
  ]
};

const mapOptions = {
  center: new naver.maps.LatLng(37.3595704, 127.105399),
  zoom: 10
};

const map = new naver.maps.Map('map', mapOptions);

let allData = [];
let filteredData = [];
let allMarkers = [];
let markerList = [];
let infowindowList = [];
let selectedStatus = "";

// 데이터 불러오기
$.ajax({
  url: "/location",
  type: "GET"
}).done((response) => {
  if (response.message !== "success") return;
  allData = response.data;

  setFilterOptions(allData);
  renderMarkersAndList(allData);
});

// 필터 옵션 동적 생성 (년도, 월, 시도)
function setFilterOptions(data) {
  const years = [...new Set(data.map(d => d.date && d.date.slice(0,4)).filter(Boolean))].sort();
  const months = [...new Set(data.map(d => d.date && d.date.slice(5,7)).filter(Boolean))].sort();
  const sidos = Object.keys(SIDO_SIGUNGU_MAP);

  $('#filter-year').append(years.map(y => `<option value="${y}">${y}년</option>`));
  $('#filter-month').append(months.map(m => `<option value="${m}">${parseInt(m,10)}월</option>`));
  $('#filter-sido').append(sidos.map(s => `<option value="${s}">${s}</option>`));
}

// 시도 선택 시 해당 시군구만 옵션으로 동적 생성
$(document).on('change', '#filter-sido', function() {
  const sido = $(this).val();
  const $sigungu = $('#filter-sigungu');
  $sigungu.empty().append('<option value="">시·군·구 선택</option>');
  if (sido && SIDO_SIGUNGU_MAP[sido]) {
    SIDO_SIGUNGU_MAP[sido].forEach(sg => {
      $sigungu.append(
        `<option value="${sg.name}" data-lat="${sg.lat}" data-lng="${sg.lng}">${sg.name}</option>`
      );
    });
  }
  $sigungu.val('');
});

// 시군구 선택 시 지도 중심 이동 (option의 data-lat, data-lng 사용)
$(document).on('change', '#filter-sigungu', function() {
  const $selected = $(this).find('option:selected');
  const lat = $selected.data('lat');
  const lng = $selected.data('lng');
  if (lat && lng) {
    map.setCenter(new naver.maps.LatLng(lat, lng));
    map.setZoom(11);
  }
});

// 필터 이벤트 (연도, 월, 시도 변경 시)
$(document).on('change', '#filter-year, #filter-month, #filter-sido', applyFilters);
$(document).on('click', '#filter-reset', function() {
  $('.filter-section select').val('');
  $('#filter-sigungu').empty().append('<option value="">시·군·구 선택</option>');
  applyFilters();
});

// 질병명 버튼 이벤트
$(document).on('click', '.disease-buttons button', function() {
  $('.disease-buttons button').removeClass('active');
  $(this).addClass('active');
  selectedStatus = $(this).data('status') || "";
  applyFilters();
});

// 필터 적용 함수 (시군구는 데이터 필터에 포함 X)
function applyFilters() {
  const year = $('#filter-year').val();
  const month = $('#filter-month').val();

  filteredData = allData.filter(d => {
    let statusMatch = true;
    if (selectedStatus) {
      if (selectedStatus === "기타") {
        statusMatch = !["병해충","구제역","아프리카돼지열병","조류인플루엔자"].includes(d.status);
      } else if (selectedStatus === "아프리카돼지열병") {
        statusMatch = d.status === "아프리카돼지열병";
      } else if (selectedStatus === "조류인플루엔자") {
        statusMatch = d.status === "조류인플루엔자";
      } else {
        statusMatch = d.status === selectedStatus;
      }
    }
    return statusMatch
      && (!year || (d.date && d.date.slice(0,4) === year))
      && (!month || (d.date && d.date.slice(5,7) === month))
  });

  renderMarkersAndList(filteredData);
}

// 마커 및 리스트/건수 렌더링 (기존과 동일)
function renderMarkersAndList(data) {
  if (allMarkers.length) {
    allMarkers.forEach(obj => obj.marker.setMap(null));
    allMarkers = [];
  }
  markerList = [];
  infowindowList = [];

  for (let i in data) {
    const target = data[i];
    if (!target.lat || !target.lng) continue;
    const latlng = new naver.maps.LatLng(target.lat, target.lng);

    let markerColorClass = '';
    switch (target.status) {
      case '병해충': markerColorClass = 'marker-yellow'; break;
      case '구제역': markerColorClass = 'marker-green'; break;
      case '아프리카돼지열병': markerColorClass = 'marker-red'; break;
      case '조류인플루엔자': markerColorClass = 'marker-blue'; break;
      default: markerColorClass = 'marker-default'; break;
    }

    let marker = new naver.maps.Marker({
      map: map,
      position: latlng,
      icon: {
        content: `<div class="marker ${markerColorClass}"></div>`,
        anchor: new naver.maps.Point(7.5, 7.5),
      },
    });

    const content = `
      <div class="infowindow_wrap">
        <div class="infowindow_title">${target.title || ""}</div>
        <div class="infowindow_status">${target.status || ""}</div>
        <div class="infowindow_status">${target.count || ""}</div>
        <div class="infowindow_status">${target.date || ""}</div>
      </div>
    `;

    const infowindow = new naver.maps.InfoWindow({
      content: content,
      backgroundColor: "#00ff0000",
      borderColor: "#00ff0000",
      anchorSize: new naver.maps.Size(0,0),
    });

    markerList.push(marker);
    infowindowList.push(infowindow);
    allMarkers.push({ marker, status: target.status, infowindow });

    naver.maps.Event.addListener(marker, "click", (() => {
      return () => {
        if (infowindow.getMap()) {
          infowindow.close();
        } else {
          infowindowList.forEach(win => win.close());
          infowindow.open(map, marker);
        }
      };
    })());
    naver.maps.Event.addListener(map, "click", (() => {
      return () => {
        infowindow.close();
      };
    })());
  }

  // 드래그 스크롤
  const frame = document.getElementById('occur-table-frame');
  let isDown = false;
  let startY, scrollTop;

  frame.addEventListener('mousedown', function(e) {
    isDown = true;
    frame.classList.add('active');
    startY = e.pageY - frame.offsetTop;
    scrollTop = frame.scrollTop;
  });
  frame.addEventListener('mouseleave', function() {
    isDown = false;
    frame.classList.remove('active');
  });
  frame.addEventListener('mouseup', function() {
    isDown = false;
    frame.classList.remove('active');
  });
  frame.addEventListener('mousemove', function(e) {
    if (!isDown) return;
    e.preventDefault();
    const y = e.pageY - frame.offsetTop;
    const walk = y - startY;
    frame.scrollTop = scrollTop - walk;
  });

  // 표 형태로 리스트 렌더링
  $('#occur-list').empty();
  data.forEach((d, idx) => {
    $('#occur-list').append(
      `<tr>
        <td>${idx + 1}</td>
        <td>${(d.sido || "")} ${(d.sigungu || "")} ${(d.title ? d.title : "")}</td>
        <td>${d.date || ""}</td>
      </tr>`
    );
  });
  $('#occur-count').text(data.length);

  if (data.length > 0) {
    const dates = data.map(d => d.date).filter(Boolean).sort();
    $('#occur-date-range').text(`${dates[0]} ~ 현재`);
  } else {
    $('#occur-date-range').text('');
  }
}
